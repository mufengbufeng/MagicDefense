# 2048游戏重构实施计划

## 一、项目结构
```
Assets/GameScripts/HotFix/GameLogic/
├── GameController/2048/
│   ├── Input/
│   │   ├── IInputHandler.cs
│   │   ├── InputManager.cs
│   │   ├── KeyboardInputHandler.cs
│   │   ├── TouchInputHandler.cs
│   │   ├── MouseInputHandler.cs
│   │   └── InputEventDispatcher.cs
│   └── Game2048Controller.cs
├── GameView/2048/
│   ├── UI/
│   │   ├── UIManager.cs
│   │   └── GMPanelController.cs
│   ├── Grid/
│   │   ├── GridManager.cs
│   │   └── CellPoolManager.cs
│   ├── Animation/
│   │   └── CellAnimationController.cs
│   └── GameRoot2048View.cs
└── GameModel/2048/
    └── Game2048Model.cs
```

## 二、重构步骤

### Phase 1: 输入系统重构

#### Step 1: 创建基础接口
```csharp
public interface IInputHandler
{
    bool IsEnabled { get; set; }
    void Update();
    void Enable();
    void Disable();
}
```

#### Step 2: 实现具体输入处理器
```csharp
public class KeyboardInputHandler : IInputHandler
{
    private bool _isEnabled = true;
    public bool IsEnabled
    {
        get => _isEnabled;
        set => _isEnabled = value;
    }

    public void Update()
    {
        if (!IsEnabled) return;
        // 处理键盘输入
    }

    public void Enable() => IsEnabled = true;
    public void Disable() => IsEnabled = false;
}

// 类似地实现TouchInputHandler和MouseInputHandler
```

#### Step 3: 重构InputManager
```csharp
public class Game2048InputManager : Singleton<Game2048InputManager>
{
    private List<IInputHandler> _handlers = new List<IInputHandler>();
    private bool _isAnimating = false;

    protected override void Init()
    {
        base.Init();
        InitializeHandlers();
    }

    private void InitializeHandlers()
    {
        _handlers.Add(new KeyboardInputHandler());
        _handlers.Add(new TouchInputHandler());
        _handlers.Add(new MouseInputHandler());
    }

    public void Update()
    {
        if (_isAnimating) return;
        foreach (var handler in _handlers)
        {
            handler.Update();
        }
    }
}
```

### Phase 2: 视图系统重构

#### Step 1: 创建UIManager
```csharp
public class UIManager
{
    private TextMeshProUGUI _topValueText;
    private TextMeshProUGUI _scoreText;
    private Button _resetBtn;
    private Button _menuBtn;

    public void Initialize(ReferenceCollector rc)
    {
        // 初始化UI元素
    }

    public void UpdateScore(int score)
    {
        _scoreText.text = score.ToString();
    }
}
```

#### Step 2: 创建GridManager
```csharp
public class GridManager
{
    private CellPoolManager _cellPool;
    private Dictionary<int, Cell2048View> _cellViews;
    private Dictionary<int, Vector2> _cellPosDict;

    public void Initialize()
    {
        // 初始化网格
    }

    public void UpdateCell(int row, int col, int value)
    {
        // 更新格子
    }
}
```

#### Step 3: 创建CellAnimationController
```csharp
public class CellAnimationController
{
    private GridManager _gridManager;
    private float _moveTime = 0.05f;

    public async UniTask AnimateMove(Vector2Int direction)
    {
        // 处理移动动画
    }
}
```

### Phase 3: 事件系统优化

#### Step 1: 优化事件定义
```csharp
public static class Game2048Events
{
    public struct CellUpdateEvent
    {
        public int Row;
        public int Col;
        public int Value;
    }

    public struct ScoreUpdateEvent
    {
        public int Score;
        public int BestScore;
    }
}
```

## 三、实施顺序

1. 输入系统重构
   - 创建IInputHandler接口
   - 实现各个输入处理器
   - 重构InputManager
   - 测试输入系统

2. 视图系统重构
   - 实现UIManager
   - 实现GridManager
   - 实现CellAnimationController
   - 实现GMPanelController
   - 重构GameRoot2048View

3. 事件系统优化
   - 优化事件结构
   - 更新事件发送和接收机制
   - 测试事件系统

4. 整体联调和测试
   - 功能测试
   - 性能测试
   - Bug修复

## 四、注意事项

1. 保持向下兼容性
2. 每个步骤完成后进行测试
3. 保持代码的可读性和可维护性
4. 注意内存管理和性能优化
5. 完善注释和文档

## 五、时间估算

1. 输入系统重构: 2天
2. 视图系统重构: 3天
3. 事件系统优化: 1天
4. 整体测试和调优: 2天

总计：8个工作日